---
name: pmbook
description: |
  PM（项目经理）的持久记忆系统 + 工作助手。

  核心能力：
  - 沟通记忆：自动结构化会议纪要，再也不怕"之前不是说好了吗"
  - 进度风险：一个命令掌握所有课题状态和风险
  - 报告生成：从记忆中自动生成周报/月报
  - 决策追溯：记录每个重要决策的背景和原因

  触发条件：
  (1) 用户说"开完会了"、"和客户聊了"、"确认了XX"
  (2) 用户问"进度怎么样"、"风险有哪些"、"XX课题的状态"
  (3) 用户说"帮我写周报"、"写报告"、"总结一下"
  (4) 用户说"为什么当初选了XX"、"之前说好的XX"
  (5) 用户接手新项目或开始新会话
  (6) 项目中存在 .pm/ 目录
  (7) 用户说"同步一下"、"项目有什么变化"、"更新记忆"
---

# PM Playbook

让 AI 成为你的项目助理——记住每次沟通、追踪每个课题、生成每份报告。

## 核心理念

```
PM 最怕的四件事：
1. "之前不是说好了吗？"         → 沟通记忆解决
2. "这个课题怎么没人跟？"       → 进度追踪解决
3. "周报又得写到几点？"         → 自动生成解决
4. "这个项目的背景是？"         → 一键 onboard 解决
```

**设计原则**（取自 project-playbook 精华，去掉研发偏向）：

- **记忆 > 文档**：不是写文档，是让 AI 帮你记住上下文
- **自动更新 > 靠自觉**：明确的触发规则，不是"判断是否需要更新"
- **一次一问**：不要一次抛 5 个问题，先给建议再确认
- **轻量起步**：只用 `/pmbook meeting` 就能开始，其他按需

---

## 记忆结构

```
project/
└── .pm/
    ├── MEMORY.md           # 项目总览 + 索引（< 150 行）
    ├── meetings/           # 会议纪要（L0/L1/L2 三层单文件）
    │   └── YYYY-MM-DD-主题.md
    ├── decisions/          # 决策记录（L0/L1/L2 三层单文件）
    │   └── YYYY-MM-DD-决策标题.md
    ├── actions.md          # Action Items 活动清单
    └── archive.md          # 归档记录（压缩时自动创建）
```

**只有 MEMORY.md 是必需的**。meetings/ 和 decisions/ 按使用自动创建。archive.md 首次压缩时自动生成。

### 三层信息模型（L0/L1/L2 单文件）

每个会议纪要和决策记录都在**单个文件**内包含三层信息，通过 frontmatter + 分隔线区分：

```
┌─ frontmatter ─────────────────────────────┐
│ abstract: "80字核心结论"                    │ ← L0 (~20 tokens)
│ date / type / participants                 │    批量筛选用
└────────────────────────────────────────────┘
┌─ 正文上半部 ──────────────────────────────┐
│ ## 结论                                    │ ← L1 (~200 tokens)
│ ## 决定事项                                │    确认相关性用
│ ## Action Items                            │
└────────────────────────────────────────────┘
                   ---
┌─ 正文下半部 ──────────────────────────────┐
│ ## 详情                                    │ ← L2 (完整内容)
│ 讨论过程、原话引用、上下文备注              │    精读用
└────────────────────────────────────────────┘
```

**读取逻辑**：L0 筛选 → L1 确认 → L2 精读，逐层深入省 token。
**向后兼容**：旧文件无 frontmatter 时 fallback 读全文。

---

## 会话协议

### 开始工作时

1. 检查 `.pm/MEMORY.md` 是否存在
2. **存在** → 读取，显示简要状态：
   ```
   📋 {项目名} | 状态：进行中
   ⚡ 焦点：客户要求3月上线第一版
   ⚠️ 风险：2个活跃（1个高优先）
   📌 待办：5个 Action Items（1个逾期）
   ```
   然后检查同步状态：
   - 读取 `last_sync_date`
   - 快速检测是否有新变更（Git: `git log --since --oneline` 计数; 非 Git: 查找更新文件）
   - 如有变更：追加显示 `🔄 上次同步后有 {N} 个变更，需要 /pmbook sync 吗？`
   - 如无变更：不显示额外信息（静默通过）
3. **不存在** → 提示："还没有 PM 记忆，要初始化吗？"

### 完成工作后

以下情况 **必须更新**（不是"判断"，是一定做）：

| 做了什么 | 必须更新 |
|---------|---------|
| 记录了会议 | meetings/ 新增 + MEMORY.md "最近事项" + actions.md |
| 记录了决策 | decisions/ 新增 + MEMORY.md "最近事项" |
| 变更了风险 | MEMORY.md 风险表格 |
| 完成了里程碑 | MEMORY.md 里程碑状态 + 触发复盘 |
| 执行了 /pmbook sync | MEMORY.md "最近事项" + last_sync_date |
| 关闭了风险 | MEMORY.md 风险表移除 + 教训备忘 + archive.md |

---

## 命令

| 命令 | 作用 | 什么时候用 |
|------|------|-----------|
| `/pmbook init` | 初始化项目 PM 记忆 | 新项目或想规范现有项目 |
| `/pmbook meeting` | 会议纪要 + 提取 Action Items | 开完会后（最核心的命令） |
| `/pmbook decision [主题]` | 记录重要决策的背景 | 做出关键决定后 |
| `/pmbook track` | 查看所有课题和 Action Items | 每日确认或随时 |
| `/pmbook risk` | 查看和更新风险清单 | 发现问题或定期评审时 |
| `/pmbook report [weekly\|monthly]` | 从记忆自动生成报告 | 写周报/月报前 |
| `/pmbook onboard` | 项目快速了解 | 接手项目或新 AI 会话开始 |
| `/pmbook check` | PM 实践健康度检查 | 想看项目管理是否规范 |
| `/pmbook sync` | 检测项目变化，同步记忆 | 新会话开始时 / 感觉记忆落后时 |

---

## /pmbook init

初始化项目的 PM 记忆。

### 交互流程（一次一问）

1. "这个项目叫什么？一句话描述是什么？"
2. "主要干系人有谁？（客户方、己方上级、技术负责人）"
3. "当前最重要的 1-3 件事是什么？"
4. "有没有已知的风险或难点？"

**每问一个，等用户回答后再问下一个。**

### 执行

1. 创建 `.pm/` 目录 + meetings/ + decisions/
2. 生成 `MEMORY.md`（含 last_sync_date 和实体索引段）
3. 创建 `actions.md`（空清单）
4. （不创建 archive.md — 首次压缩时自动生成）
5. 提示："初始化完成。下次开完会试试 `/pmbook meeting`。"

### MEMORY.md 模板

```markdown
# {项目名}

> 一句话：{项目描述}
> 状态：{待启动 / 进行中 / 收尾中 / 已完成}
> PM：{谁}
> 最后更新：YYYY-MM-DD
> last_sync_date: YYYY-MM-DD

## 关键干系人

| 角色 | 姓名 | 关注点 | 沟通频率 |
|------|------|--------|---------|
| 客户方 | | | |
| 己方上级 | | | |
| 技术负责人 | | | |

## 实体索引

> 项目中的关键人物、系统、术语。新实体在会议中首次出现时自动建议添加。
> 超过 20 条时提取到 entities.md。

| 实体 | 类型 | 说明 | 首次出现 | 相关决策 |
|------|------|------|---------|---------|

## 当前焦点

1. {最重要的事}
2. {第二重要的事}

## 活跃风险

| ID | 风险 | 影响 | 概率 | 负责人 | 对策 | 状态 |
|----|------|------|------|--------|------|------|

## 里程碑

| 里程碑 | 计划日期 | 状态 | 备注 |
|--------|---------|------|------|

## 最近重要事项

- YYYY-MM-DD: {简述}

## 教训备忘

{复盘中积累的经验教训 + 已关闭风险的教训}

## 索引

- 会议纪要：`meetings/`
- 决策记录：`decisions/`
- Action Items：`actions.md`
- 归档记录：`archive.md`（压缩后自动生成）
```

---

## /pmbook meeting

**最核心的命令。** 将沟通内容结构化为纪要 + 自动提取 Action Items。

### 使用方式

**方式 1：口述整理（推荐）**

用户直接说出会议内容，可以很乱，AI 自动整理：

```
我：刚和客户张总开完会，他说3月必须上线第一版，功能可以砍但登录和搜索必须有。
李工说搜索用ES两周能搞定。客户不要暗色模式了。下周三再开一次确认接口。
```

AI 自动输出结构化纪要，不需要额外引导。

**方式 2：引导式**

如果用户只说"刚开完会"但没有内容，AI 依次引导：

1. "和谁开的什么会？"
2. "主要结论是什么？"
3. "有哪些 Action Items？谁负责、什么时候完成？"

**最多 3 问，不要过度引导。**

### 输出

生成 `.pm/meetings/YYYY-MM-DD-{主题}.md`：

```markdown
---
abstract: "{核心结论，逗号分隔，不超过80字}"
date: YYYY-MM-DD
type: "{客户会议 / 内部同步 / 评审会 / 1on1}"
participants: ["{参与者1}", "{参与者2}"]
---

# {会议主题}

## 结论

- {结论1}
- {结论2}

## 决定事项

- {决定1}（背景：{为什么}）
- {决定2}

## Action Items

- [ ] @{谁} {做什么} (截止: MM-DD)
- [ ] @{谁} {做什么} (截止: MM-DD)

---

## 详情

{讨论过程、原话引用、上下文备注等完整内容}
```

**三层说明：**
- **L0（frontmatter）**：`abstract` 字段，80字以内。批量扫描时只读 frontmatter
- **L1（结论→Action Items）**：从标题到第一个 `---` 分隔线。确认相关性时读到这里
- **L2（详情）**：`---` 分隔线之后的完整讨论记录。仅在需要精读时读取

**abstract 生成规则：**
- 从"结论"和"决定事项"中提取最重要的 2-3 个要点
- 用逗号分隔，不超过 80 字符
- 优先级：决策 > 结论 > Action Items
- 示例：`abstract: "客户确认3月上线，砍掉暗色模式，搜索用ES方案"`

### 自动联动（必须执行，不是"判断"）

1. **更新 actions.md** — 合入新的 Action Items（执行去重逻辑，见下方）
2. **更新 MEMORY.md** — "最近重要事项"增加一条
3. **检测决策** — 如果有重大决定（影响范围/时间/成本），提示："这个决定比较重要，要单独记录决策背景吗？"
4. **检测风险** — 如果提到问题/困难/延迟，提示："要加入风险清单吗？"
5. **检测新实体** — 如果会议中出现以下情况，提示添加到实体索引：
   - 首次提到的人名（不在"关键干系人"和"实体索引"中的）
   - 首次提到的系统/工具名称
   - 首次提到的专有术语或模块名
   - 提示格式："会议中提到了 {实体名}，要加入实体索引吗？"
   - 用户确认后才添加，不自动添加
6. **检查压缩** — 如果 MEMORY.md 超过 130 行，触发压缩（见"记忆压缩策略"）
7. **VOC 分析提示** — 如果会议类型为"客户会议"，提示："这是客户会议，要做 VOC 深度分析吗？（`/voc`）"。用户确认后调用 `/voc-insight` skill

### Action Items 去重逻辑

从会议中提取的 Action Items 写入 actions.md 前，必须与现有项执行去重比较。

**比较维度：**
- 负责人（@谁）
- 任务内容（语义相似，不要求字面一致）
- 截止日期

**判定三种结果：**

| 判定 | 条件 | 操作 |
|------|------|------|
| CREATE | 现有清单中无相似项 | 在 actions.md 末尾新增 |
| UPDATE | 相似项存在但有新信息（新截止日期、补充细节、scope变化） | 更新现有项，标注 `(更新: MM-DD)` |
| SKIP | 完全重复（同人同事同期限） | 不写入，不提示 |

**执行流程：**

1. 读取 actions.md 全部内容
2. 逐条比较新 Action Item 与现有项
3. 对每条判定 CREATE / UPDATE / SKIP
4. 向用户呈现判定结果：
   ```
   📌 Action Items 更新：
   - ✅ 新增：@王设计 出登录页设计稿 v2 (截止: 2/15)
   - 🔄 更新：@李工 搜索接口文档 — 截止日期从 2/10 改为 2/14（客户会上同意延期）
   - ⏭️ 跳过：@我 发会议纪要（已存在相同项）
   ```
5. 用户确认后写入
6. UPDATE 操作保留原始创建日期，追加更新标注

**UPDATE 格式示例：**
```
- [ ] @李工 完成搜索接口文档 (截止: 2/14, 原: 2/10, 更新: 2/12)
```

---

## /pmbook decision [主题]

记录重要决策的完整背景。解决"为什么当初选了 XX"的问题。

### 什么算"重要决策"

- 影响项目范围、工期、成本的决定
- 客户明确要求或放弃的功能
- 技术方案的关键选择
- 人员或资源的重大调整

### 输出

生成 `.pm/decisions/YYYY-MM-DD-{主题}.md`：

```markdown
---
abstract: "{决策结论一句话，不超过80字}"
date: YYYY-MM-DD
decision_maker: "{谁做的决定}"
source: "{哪次会议 / 邮件 / 即时沟通}"
status: "{已确定 / 待最终确认}"
---

# 决策：{标题}

## 背景

{什么触发了这个决策，当时的状况}

## 结论

选择 {方案X}。
核心原因：{一句话说清楚为什么}

## 影响

- {对谁/什么产生影响}

## 后续

- [ ] @{谁} {做什么} (截止: MM-DD)

---

## 详情

### 方案对比

| | 方案 A: {名称} | 方案 B: {名称} |
|---|---|---|
| 概述 | | |
| 优势 | | |
| 劣势 | | |
| 工期影响 | | |

{其他讨论过程、备选方案分析、利益相关方意见等完整记录}
```

**三层说明：** 同会议纪要——frontmatter 为 L0，结论/影响/后续为 L1，`---` 之后的方案对比和详细讨论为 L2。
**abstract 生成规则：** 同会议纪要。示例：`abstract: "搜索方案选ES，因客户要求3月上线，Solr方案需4个月"`

> 如果不需要方案对比（比如客户直接拍板），可以省略方案对比部分，只记背景和结论。

---

## /pmbook track

一览当前所有课题和 Action Items 状态。

### 执行

1. 读取 `actions.md` 所有 Action Items
2. 读取 `MEMORY.md` 的里程碑
3. 扫描最近 meetings/ 中的未完成项
4. 按紧急程度排序输出

### 输出格式

```
## 📋 {项目名} 进度追踪（YYYY-MM-DD）

### 🔴 逾期
- @李工 完成搜索接口文档 (截止: 2/5, 逾期1天)

### 🟡 本周到期
- @我 和客户确认砍掉的功能清单 (截止: 2/7)
- @王设计 登录页面设计稿 (截止: 2/8)

### 🟢 进行中
- @李工 ES搜索模块开发 (截止: 2/20)

### ✅ 最近完成
- @我 发送会议纪要给客户 (完成: 2/6)

### 里程碑
- ⏳ 接口确认 — 2/14（还剩8天）
- ⏳ 第一版上线 — 3/1（还剩23天）

### 💡 建议
1. @李工 的接口文档已逾期，建议今日确认原因
2. 里程碑"接口确认"还剩8天，当前3个前置任务中有1个逾期
```

---

## /pmbook risk

管理风险清单。

### 使用

- `/pmbook risk` — 显示当前活跃风险
- `/pmbook risk add` — 添加新风险（AI 引导填写）
- `/pmbook risk update` — 更新已有风险状态

### 风险记录在 MEMORY.md 的"活跃风险"表中

```
| ID | 风险 | 影响 | 概率 | 负责人 | 对策 | 状态 |
|----|------|------|------|--------|------|------|
| R1 | 客户3月需求变更 | 高 | 中 | PM | 每周确认范围 | 监控中 |
| R2 | 后端人力不足 | 高 | 高 | CTO | 协调借调 | 升级中 |
```

高影响风险附加详情（也在 MEMORY.md 中）：

```
### R2: 后端人力不足
- 2/4 发现：当前2人，方案需要3人
- 2/5 上报CTO，讨论借调方案
- 2/6 CTO回复：可借调1人，2/10到位
- → 风险降级为"低"
```

### 关闭风险

当风险被关闭时：
1. 从 MEMORY.md "活跃风险"表中移除
2. 如果有教训意义，添加一行到 MEMORY.md "教训备忘"
3. 添加到 archive.md "已关闭风险"表（archive.md 不存在时自动创建）

### 主动提醒

以下情况 **主动提醒** 评审风险：
- 里程碑前 2 周
- 有新的重大决策时
- 连续 2 周没有更新风险

---

## /pmbook report [weekly|monthly]

从记忆中自动生成报告。**PM 最省时间的命令。**

### 执行

1. 读取 MEMORY.md 获取项目概况
2. 扫描本周期内 meetings/ 和 decisions/ 的 frontmatter：
   a. 先只读取每个文件的 YAML frontmatter（L0 层：abstract + date + type）
   b. 根据 abstract 和 date 判断是否与本周期相关
   c. 对相关文件读取 L1 层（结论/决定/Action Items）提取要点
   d. 仅在需要深度背景时读取 L2 层（详情）
   e. 旧文件若无 frontmatter，fallback 读取全文
3. 汇总 actions.md 完成情况
4. 检查风险变化
5. 生成报告

### 周报模板

```markdown
# {项目名} 周报

> 期间：YYYY/MM/DD ~ YYYY/MM/DD
> PM：{谁}

## 本周概要

{2-3句话总结本周最重要的进展}

## 进展

| 课题 | 状态 | 说明 |
|------|------|------|
| {课题1} | ✅ 完成 | {简述} |
| {课题2} | ⏳ 进行中 | {进度和预期} |
| {课题3} | ⚠️ 延迟 | {原因和对策} |

## 本周决定

- {决定1}（{日期}，{参与者}）

## 风险状况

| 风险 | 等级 | 对策 | 本周变化 |
|------|------|------|---------|
| {风险1} | 高 | {对策} | 新增 / 不变 / 改善 / 升级 |

## 下周计划

- {计划1}
- {计划2}

## 需要支持

- {需要上级/客户/其他团队帮助的事项，没有则写"无"}
```

### 月报

在周报基础上增加：
- 里程碑达成情况（计划 vs 实际）
- 重要决策汇总
- 本月教训总结（从复盘中提取）

### 双语支持

如需日文版报告，AI 在生成中文版后询问：
"需要生成日文版吗？"

---

## /pmbook onboard

快速了解项目全貌。新接手项目或开始新 AI 会话时使用。

### 执行

1. 读取 MEMORY.md 获取项目概况和实体索引
2. 扫描 meetings/ 和 decisions/ 的 frontmatter（L0 层：abstract + date），构建时间线
3. 对关键事件读取 L1 层（结论/决定）提取背景，必要时读 L2 层（旧文件无 frontmatter 时 fallback 读全文）
4. 读取 actions.md 未完成项
5. 生成 onboard 摘要

### 输出

```
## {项目名} 快速了解

### 这是什么
{一句话描述}

### 关键人物
- 客户方：{谁}（关注{什么}）
- 技术负责人：{谁}

### 关键实体
{从实体索引提取，帮助新人理解项目中的专有名词和关键系统}
- ES (Elasticsearch): 搜索引擎方案
- 张总: 客户方决策人

### 当前状态
- 阶段：{进行中}
- 下一个里程碑：{什么}（{日期}，还剩{N}天）
- 活跃风险：{N}个（最高级：{描述}）

### 最近动态
- {最近3-5条重要事项，从 MEMORY.md 提取}

### 待办
- {未完成的 Action Items，按紧急度排序}

### ⚠️ 必须知道的背景
{从决策记录和会议纪要中提取的关键上下文}
- 例："客户张总在2/6明确表示3月必须上线，宁可砍功能"
- 例："暗色模式已被客户取消（2/6决定）"
```

---

## /pmbook check

PM 实践健康度检查。

### 检查项

```
PM 实践检查
├── ✅/❌ .pm/MEMORY.md 存在
├── ✅/❌ MEMORY.md 最后更新 < 1 周
├── ✅/❌ MEMORY.md 行数 < 150
├── ✅/❌ 关键干系人信息完整
├── ✅/❌ 本周有会议纪要记录
├── ✅/❌ 最近会议纪要有 frontmatter（含 abstract 字段）
├── ✅/❌ 活跃风险已识别（不为空）
├── ✅/❌ 风险最近 2 周内有更新
├── ✅/❌ Action Items 无逾期超过 3 天的
├── ✅/❌ 里程碑日期明确
├── ✅/❌ 重要决策有记录
├── ✅/❌ 最近 2 周有周报
└── ✅/❌ last_sync_date 在 1 周内

总分: X/13
```

---

## /pmbook sync

检测项目变化，同步记忆。解决"AI 不知道上次之后项目发生了什么"的问题。

### 触发方式

**自动提醒（会话开始时）：**

当 `.pm/` 存在时，会话开始的状态检查增加一步：
1. 读取 MEMORY.md 头部的 `last_sync_date`
2. 检测项目文件变化（见下方检测方法）
3. 如果有变化，在状态信息后追加提醒：
   ```
   🔄 上次同步后有 {N} 个文件变更（{日期范围}），需要 /pmbook sync 吗？
   ```
4. 用户确认后才执行完整同步，不自动同步

**手动命令：**

用户随时可以执行 `/pmbook sync` 触发完整同步流程。

### 检测方法

**优先使用 Git（大多数项目）：**

```bash
git log --since="{last_sync_date}" --name-only --pretty=format:"%H %s" -- . ':!.pm'
```
- 排除 .pm/ 目录自身的变更
- 提取：变更文件列表、commit 摘要

**非 Git 项目的回退方案：**
- 读取 MEMORY.md 中的 `last_sync_date`
- 列出项目根目录下修改时间晚于 `last_sync_date` 的文件（排除 .pm/）
- 只报告文件变更列表，不含变更摘要

### 执行流程

1. **检测变更** — 使用上述方法获取变更列表
2. **分类呈现** — 将变更按类型分组显示给用户：
   ```
   🔄 上次同步 (YYYY-MM-DD) 以来的变更：

   代码变更 (12个文件)
   - src/search/ 下 5 个文件（搜索模块）
   - src/auth/ 下 3 个文件（登录模块）
   - ...

   配置/文档变更 (3个文件)
   - README.md
   - config/deploy.yaml
   - ...

   Git 提交摘要：
   - "feat: ES搜索基础框架" (2/10)
   - "fix: 登录token过期问题" (2/11)
   - ...
   ```
3. **用户确认** — "这些变更中，哪些需要更新到 PM 记忆？（或者说'全部'/'跳过'）"
4. **更新记忆** — 根据用户反馈：
   - 相关进展 → 更新 MEMORY.md "最近重要事项"
   - 里程碑完成 → 更新 MEMORY.md 里程碑状态
   - 新风险暴露 → 提示加入风险清单
   - Action Items 完成 → 更新 actions.md 打勾
5. **更新同步时间** — 更新 MEMORY.md 头部 `last_sync_date` 为当前日期

### 不做什么

- **不自动修改记忆**（总是先呈现，再由用户确认）
- **不分析代码内容**（只看文件名和 commit message）
- **不替代 /pmbook meeting**（sync 是补充性的，会议纪要仍是主要信息来源）

---

## 主动触发规则

不等用户调用命令，以下情况 **主动提醒**：

| 用户说了什么 | AI 主动提醒 |
|-------------|-----------|
| "刚开完会" "和客户聊了" "和XX确认了" | "要记录一下这次沟通吗？我帮你整理。" |
| "决定了..." "确认用..." "客户同意..." | "这个决定比较重要，要记录决策背景吗？" |
| "有个问题" "来不及" "有风险" "延迟了" | "要加入风险清单吗？" |
| "帮我写周报" "写报告" "总结一下" | 直接执行 /pmbook report |
| "这个项目是什么" "背景是" "之前怎么说的" | 读取记忆回答，或执行 /pmbook onboard |
| 提到了某个过去的决策 | 从 decisions/ 中查找并呈现完整背景 |
| "同步一下" "更新记忆" "项目有什么变化" | 执行 /pmbook sync |
| 新会话开始时，检测到项目文件变更 | "🔄 上次同步后有变更，需要 /pmbook sync 吗？" |

---

## 里程碑复盘

每个里程碑完成（或延迟确认）时，执行简要复盘：

```markdown
## 里程碑复盘：{名称}

> 计划：YYYY-MM-DD → 实际：YYYY-MM-DD（按时 / 延迟N天 / 提前N天）

### 做得好
- {好的方面}

### 做得不够
- {需要改进的}

### 教训
- {下次要注意的，记入 MEMORY.md 教训备忘}
```

---

## 记忆压缩策略

MEMORY.md 必须保持 < 150 行。以下规则定义何时、如何压缩。

### 触发时机

以下情况检查是否需要压缩：
- `/pmbook meeting` 执行后（新增了"最近重要事项"条目时）
- `/pmbook sync` 执行后（更新了记忆内容时）
- MEMORY.md 超过 130 行时（预警线）

### "最近重要事项" 压缩规则

| 条目年龄 | 处理 |
|----------|------|
| < 2 个月 | 保持原样 |
| 2-4 个月 | 合并压缩（同月的 3 条 → 1 条月度概要） |
| > 4 个月 | 转移到 `.pm/archive.md` |

**压缩示例：**

原始（3条）：
```
- 2025-12-05: 客户确认搜索用 ES 方案
- 2025-12-03: 和客户讨论暗色模式，决定砍掉
- 2025-12-01: kickoff会议，确认3月上线目标
```

压缩后（1条）：
```
- 2025-12月: 项目启动，确认3月上线、ES搜索方案、砍掉暗色模式
```

### 活跃风险压缩规则

| 风险状态 | 处理 |
|----------|------|
| 监控中 / 升级中 | 保留在"活跃风险"表中 |
| 已关闭（resolved） | 从表中移除；如有教训，写一条到"教训备忘"；详情存 archive.md |
| 已接受（accepted） | 保留但标记，不计入活跃数量 |

**已关闭风险归档示例：**

从风险表中删除 R2 后，在"教训备忘"中添加：
```
- [R2] 后端人力不足：早期识别并上报是正确的，CTO 2天内解决（2025-02）
```

### 里程碑压缩规则

| 里程碑状态 | 处理 |
|------------|------|
| 未到期 | 保留完整信息 |
| 刚完成（< 1个月） | 标记 ✅，保留备注 |
| 完成 > 1个月且已复盘 | 压缩为一行：`✅ {名称} (完成: MM-DD)` |
| 完成 > 3个月 | 转移到 archive.md |

### archive.md 模板

首次压缩时自动创建：

```markdown
# 项目归档记录

> 此文件包含从 MEMORY.md 压缩出的历史条目。
> 通常不需要阅读，仅在需要追溯历史时查阅。

## 归档事项

### YYYY-MM月
- {压缩后的月度概要}

## 已关闭风险

| 原ID | 风险 | 结果 | 教训 | 关闭日期 |
|------|------|------|------|---------|

## 已完成里程碑

| 里程碑 | 计划 | 实际 | 偏差 | 备注 |
|--------|------|------|------|------|
```

### 实体索引溢出

当 MEMORY.md 中"实体索引"表超过 20 行时：
1. 提示用户："实体索引已有 {N} 条，建议提取到 .pm/entities.md 以保持 MEMORY.md 精简。"
2. 用户确认后，将表格移到 entities.md，MEMORY.md 中替换为：
   `> 实体索引：见 entities.md（{N} 条记录）`

---

## 与研发侧 Skill 的关系

如果项目同时使用了研发侧的 skill（feature-memory 等）：

| PM 记忆（.pm/） | 研发记忆（.features/） |
|------|------|
| "客户要求3月上线" | "选ES因为性能需求" |
| "砍掉了暗色模式" | "删除了暗色模式CSS" |
| "风险：后端人力不足" | "搜索模块的性能坑" |

**各管各的领域，互不干扰。** PM 不需要关心代码决策，研发不需要关心客户沟通。但两侧的记忆放在同一个项目里，需要时可以交叉查阅。

---

## 最佳实践

### 会后立刻记（5分钟原则）

```
✅ 开完会 → 5分钟内口述给 AI → 结构化纪要
❌ "回头再整理" → 第二天就忘了细节
```

### 记背景，不只记结论

```
✅ "选方案B，因为客户要求3月上线，方案A要4个月"
❌ "选了方案B"
```

3 个月后有人问"为什么不做方案A"，背景比结论重要 10 倍。

### Action Items 三要素

```
✅ @李工 完成搜索接口文档 (截止: 2/10)
❌ 完成搜索接口文档
```

**谁、做什么、什么时候完成**——缺一不可。

### 风险要有对策

```
✅ R2: 人力不足 → 对策：和CTO讨论借调，2/7前回复
❌ R2: 人力不足 → 对策：待定
```

### 新会话先 sync

```
✅ 新会话开始 → AI 自动检测变更 → 确认 sync → 记忆最新
❌ 新会话开始 → 直接开始工作 → 记忆可能过时
```

---

## FAQ

### Q: 和 Jira / 飞书 / Redmine 什么关系？

A: **互补，不替代。** 项目管理工具管"任务状态"，PM Playbook 管"上下文记忆"。工具告诉你任务延期了，但不能告诉你"客户当时为什么坚持这个需求"。

### Q: 记忆会越来越大怎么办？

A: MEMORY.md 保持 < 150 行。有明确的压缩策略：2 个月以上的事项自动压缩合并，4 个月以上归档到 archive.md。已关闭风险转入教训备忘。完成的里程碑复盘后压缩。详见"记忆压缩策略"部分。

### Q: 多个项目怎么办？

A: 每个项目有自己的 `.pm/` 目录。Claude 根据当前工作目录自动识别。

### Q: 最小化使用要怎么做？

A: **只用 `/pmbook meeting` 就够。** 每次沟通后口述一下，AI 帮你整理并自动维护 Action Items。这一个命令就解决了"记不住谁说了什么"的痛点。其他命令按需加入。

### Q: 能配合 project-playbook 使用吗？

A: 可以。project-playbook 管研发实践（代码结构、发布流程），pm-playbook 管项目管理实践（沟通、决策、风险）。两者在同一个项目里各管各的目录，互不冲突。

### Q: 已有的 .pm/ 目录没有 frontmatter / 实体索引 / last_sync_date 怎么办？

A: **完全兼容。** 这些都是增量改进：
- 没有 frontmatter 的旧文件照常工作（fallback 读全文），新文件会自动带上 L0/L1/L2 三层结构
- 没有实体索引的 MEMORY.md 不影响任何功能，随时可以手动添加
- 没有 last_sync_date 时，`/pmbook sync` 首次执行会自动设定
- 运行 `/pmbook check` 可以看到哪些新功能还没启用
